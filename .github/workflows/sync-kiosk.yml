name: Daily Kiosk Sync

on:
  schedule:
    # 6:00 AM WIB (UTC+7) = 23:00 UTC (previous day)
    - cron: '0 23 * * *'
  workflow_dispatch: # Allow manual trigger from GitHub UI

jobs:
  sync-kiosk:
    name: Sync Kiosk Data from Accurate
    runs-on: ubuntu-latest
    steps:
      - name: Trigger Kiosk Sync
        env:
          APP_URL: ${{ secrets.APP_URL }}
          CRON_SECRET: ${{ secrets.CRON_SECRET }}
        run: |
          if [ -z "$APP_URL" ]; then
            echo "::error::APP_URL secret is not set. Please add it in GitHub Settings > Secrets."
            exit 1
          fi

          if [ -z "$CRON_SECRET" ]; then
            echo "::error::CRON_SECRET secret is not set. Please add it in GitHub Settings > Secrets."
            exit 1
          fi

          SYNC_URL="${APP_URL}/api/cron/sync-kiosk"
          echo "Triggering kiosk sync at ${SYNC_URL}..."

          RESPONSE=$(curl -s -w "\n%{http_code}" -X GET \
            -H "Authorization: Bearer ${CRON_SECRET}" \
            "${SYNC_URL}")

          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          echo "HTTP Status: ${HTTP_CODE}"
          echo "Response: ${BODY}"

          if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
            echo "âœ… Kiosk sync completed successfully!"
          else
            echo "::error::Kiosk sync failed with HTTP ${HTTP_CODE}"
            exit 1
          fi
